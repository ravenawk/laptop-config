---
- name: Checking out some variables
  become: false
  connection: local
  hosts: nodes
  vars:
    setup_user_name: 'pmartin'
    setup_user_group: '{{(FAMILY != "MacOS") | ternary(setup_user_name, "staff")}}'

  pre_tasks:
  - name: gather package facts
    ansible.builtin.package_facts:
    when: FAMILY != 'MacOS'

  - name: Get user stat
    ansible.builtin.user:
      name: '{{ setup_user_name }}'
    check_mode: true
    register: user_stat

  - name: Display user_stat
    set_fact:
      user_home: '{{ user_stat.home }}'

  roles:
    - name: repos
      become: true
      when: FAMILY != 'MacOS'
    - name: packages
      become: true
    - name: setup_user
    - name: dotfiles
    - setup_zsh
    - name: setup_libvirt
      become: true
      when: FAMILY != 'MacOS'

  tasks:
    - name: Print out reboot var
      debug:
        var: needs_reboot.stdout
      when: FAMILY != 'MacOS'
...

